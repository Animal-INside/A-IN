<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.team.ain.mapper.ChatRoomMapper">
    
    <!-- 채팅방 생성 -->
    <insert id="insertRoom" parameterType="com.team.ain.dto.ChatRoomDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_room (
            room_name,
            room_type,
            host_id,
            is_active
        ) VALUES (
            #{roomName},
            #{roomType},
            #{hostId},
            true
        )
    </insert>
    
    <!-- 채팅방 멤버 추가 -->
    <insert id="addRoomMember">
        INSERT INTO chat_room_member (
            room_id,
            member_id,
            joined_at,
            last_read_at
        ) VALUES (
            #{roomId},
            #{userId},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>
    
    <!-- 사용자의 채팅방 목록 조회 -->
    <select id="findRoomsByUserId" resultType="com.team.ain.dto.ChatRoomDTO">
        SELECT 
            r.id,
            r.room_name,
            r.room_type,
            r.host_id,
            r.created_at,
            r.is_active,
            COUNT(DISTINCT crm.member_id) as member_count,
            (
                SELECT COUNT(*)
                FROM chat_message cm
                WHERE cm.room_id = r.id
                AND cm.created_at > crm.last_read_at
                AND cm.sender_id != #{userId}
                AND cm.is_deleted = false
            ) as unread_count
        FROM chat_room r
        JOIN chat_room_member crm ON r.id = crm.room_id
        WHERE r.is_active = true
        AND EXISTS (
            SELECT 1 
            FROM chat_room_member 
            WHERE room_id = r.id 
            AND member_id = #{userId}
        )
        GROUP BY r.id, crm.last_read_at
        ORDER BY r.created_at DESC
    </select>
    
    <!-- 채팅방 멤버인지 확인 -->
    <select id="isRoomMember" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 
            FROM chat_room_member 
            WHERE room_id = #{roomId} 
            AND member_id = #{userId}
        )
    </select>
</mapper>